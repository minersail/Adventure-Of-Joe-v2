package woohoo.gameworld;

import com.badlogic.ashley.core.Entity;
import com.badlogic.ashley.core.Family;
import com.badlogic.ashley.systems.IteratingSystem;
import com.badlogic.gdx.physics.box2d.joints.RevoluteJointDef;
import woohoo.gameobjects.components.PositionComponent;
import woohoo.gameobjects.components.PositionComponent.Orientation;
import woohoo.gameobjects.components.WeaponComponent;

public class WeaponSystem extends IteratingSystem
{
	public WeaponSystem()
	{
		super(Family.all(WeaponComponent.class, PositionComponent.class).get());
	}
	
	@Override
	protected void processEntity(Entity entity, float deltaTime)
	{
		WeaponComponent weapon = Mappers.weapons.get(entity);
		
		setAngle(weapon, Mappers.positions.get(entity).orientation);
		
		// Check if weapon is done with swing
		float rotation = weapon.mass.getTransform().getRotation();
		if (rotation < 0) rotation += 2 * (float)Math.PI;
		
		// Between 95% and 105% of the desired angle
		float upperBound = 0.95f * (weapon.weaponAngle + 2 * (float)Math.PI / 3);
		float lowerBound = 1.05f * (weapon.weaponAngle + 2 * (float)Math.PI / 3);
		
		if (lowerBound > 2 * (float)Math.PI) lowerBound -= 2 * (float)Math.PI;
		if (upperBound > 2 * (float)Math.PI) upperBound -= 2 * (float)Math.PI;
		
		// Stop swing
		if (rotation >= upperBound && rotation <= lowerBound)
		{
			weapon.isActive = false;
			weapon.mass.setTransform(weapon.mass.getTransform().getPosition(), weapon.weaponAngle);
			weapon.mass.setAngularVelocity(0);
			weapon.mass.setFixedRotation(true);
		}
	}
	
	public void equip(Entity equipped, WeaponComponent weapon)
    {
		equipped.add(weapon);
        
        RevoluteJointDef jointDef = new RevoluteJointDef();
        jointDef.bodyA = Mappers.hitboxes.get(equipped).mass;
        jointDef.bodyB = weapon.mass;
        
        Mappers.hitboxes.get(equipped).mass.getWorld().createJoint(jointDef);
			
		setAngle(weapon, Mappers.positions.get(equipped).orientation);
    }
	
	public void unequip(Entity equipped)
	{
		WeaponComponent weapon = Mappers.weapons.get(equipped);
		weapon.mass.getWorld().destroyBody(weapon.mass);
		equipped.remove(WeaponComponent.class);
	}
	
	public void setAngle(WeaponComponent weapon, Orientation dir)
	{
		switch (dir)
		{
			case West:
				weapon.weaponAngle = 2 * (float)Math.PI / 3;
				break;
			case North:
				weapon.weaponAngle = 7 * (float)Math.PI / 6;
				break;
			case East:
				weapon.weaponAngle = 5 * (float)Math.PI / 3;
				break;
			case South:
				weapon.weaponAngle = (float)Math.PI / 6;
				break;
		}
		
		weapon.weaponDirection = dir;
	}
}

//----------------------------------------------------------------------------

package woohoo.gameobjects.components;

import com.badlogic.ashley.core.Component;
import com.badlogic.gdx.math.Vector2;
import com.badlogic.gdx.physics.box2d.Body;
import com.badlogic.gdx.physics.box2d.BodyDef;
import com.badlogic.gdx.physics.box2d.Fixture;
import com.badlogic.gdx.physics.box2d.FixtureDef;
import com.badlogic.gdx.physics.box2d.PolygonShape;
import com.badlogic.gdx.physics.box2d.World;
import woohoo.gameobjects.components.PositionComponent.Orientation;

/**
 * Class containing the box2D components of a weapon
 */
public class WeaponComponent implements Component
{    
	public Body mass;
	public Fixture fixture;
	
	public float weaponAngle; // Radians
	public Orientation weaponDirection;
	public boolean isActive;
	
	public float damage;
	public float knockback;
    
    public WeaponComponent(World world) 
    {        
        BodyDef bodyDef = new BodyDef();
		mass = world.createBody(bodyDef);
        mass.setType(BodyDef.BodyType.DynamicBody);
		
		PolygonShape shape = new PolygonShape();	
		shape.setAsBox(0.5f, 0.125f, new Vector2(0.375f, 0), 0);

		FixtureDef fixtureDef = new FixtureDef();
		fixtureDef.shape = shape;
		
        fixture = mass.createFixture(fixtureDef);
		fixture.setSensor(true);
        fixture.setDensity(0.001f);
		
		isActive = false;
    }    
	
	public void swing()
	{
		isActive = true;
		mass.setFixedRotation(false);
		mass.setTransform(mass.getTransform().getPosition(), weaponAngle);
		mass.setAngularVelocity(50);
	}
}
